<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Retro</title>
</head>
<body style="background-color: darkblue;" onkeypress="handleKeypress(m, totalDecks)">
  <p id="monitor"; style="color: white; font-size: larger"></p>

  <script>
    class Card {
      constructor(text) {
        this.text = text;
      }
    }

    class Deck {
      constructor(deckData) {
        this.cards = [];
        this.deckData = deckData;
        this.createDeck();
      }

      createDeck() {
        for (let i = 0; i < this.deckData.length; i = i+2) {
          for (let j = 0; j < this.deckData[i]; j++) {
            this.cards.push(new Card(this.deckData[i+1]));            
          }
        }
      }

      shuffleDeck() {
       let location1, location2, tmp;
       for (let i = 0; i < 1000; i++) {
           location1 = Math.floor((Math.random() * this.cards.length));
           location2 = Math.floor((Math.random() * this.cards.length));
           tmp = this.cards[location1];
           this.cards[location1] = this.cards[location2];
           this.cards[location2] = tmp;
        }
      }

      drawCard() {
        // TODO: Check for no cards left in deck.
        if (this.cards.length == 0) {
          this.createDeck(this.deckData);
          this.shuffleDeck();
          alert ("Deck shuffled.");
        }
        return this.cards.pop();
      }
    }

    class Monitor {
      constructor(monitorElement) {
        this.element = monitorElement;
        this.reset();
      }

      refresh() {
        this.element.innerHTML = this.output;
      }

      reset() {
        this.output = "* Ready *<br>---<br> ";
        this.refresh();
      }

      write(text) {
        this.output = this.output.concat(text);
        this.output = this.output.concat("<br>---<br>")
        this.refresh();
        window.scrollBy(0,200);
      }
    }

    class Dashboard {
      constructor(monitor,totalDecks) {
        this.monitor = monitor;
        this.totalDecks = totalDecks;
      }
      startNewGame() {
        this.monitor.write("New game started.");
        this.round = 0;
        this.playerHasPriority = false;
        this.phase = 0;
        this.maxPhase = 8;
        this.phaseArray = [];

        this.shuffleDecks();
        this.rollPriority();
        this.displayInfo();

      }
      shuffleDecks(){
        // Rebuild and shuffle all the decks
        for (let i = 0; i < this.totalDecks.length; i++){
          this.totalDecks[i].createDeck();
          this.totalDecks[i].shuffleDeck();
        }

      }
      displayInfo() {
        let message = "Current round: " + this.round + "<br>" + this.phaseArray[this.phase];
        this.monitor.write(message);
      }
      processNextPhase() {
        this.phase++;
        if (this.phase > this.maxPhase){
          this.processNextRound();
        }
        this.displayInfo();
      }
      processNextRound() {
        this.phase = 0;
        this.round++;
        this.rollPriority();
        this.shuffleDecks();
        this.monitor.write("*** NEW ROUND ***")
      }
      rollPriority() {
        let x = Math.random();
        if (x < .5) {
          this.playerHasPriority = false;
          this.phaseArray = aiPriorityRound;
        } else {
          this.playerHasPriority = true;
          this.phaseArray = playerPriorityRound;

        }
      }
    }

    let actionDeckData = [
          2, 'RUSH<br>\
              This unit makes an Advance action. Then draw another card.',
          4, 'ADVANCE<br>\
              This unit makes an Advance action.',
          2, 'ENGAGE<br>\
              This unit makes an Engage action.',
          2, 'FORTIFY<br>\
              This unit makes a Fortify action.',
          1, 'RECOVER<br>\
              This unit Recovers D3 wounds. Then draw another card.',
    ];

    let abilityDeckData = [
      6, 'NOTHING<br>\
          The unit does not use an ability.',
      3, 'ONSLAUGHT<br>\
          Reroll failed hit rolls for this unit.',
      3, "FURY<br>\
          Increase this unit's Rend characteristic by 1.",
      3, "BESERK<br>\
          All hit rolls of 6+ inflict D3 hits on the target unit",
      3, 'FORTITUDE<br>\
          Recover D3 wounds on this unit before attacking.',
      3, 'DEATHSTRIKE<br>\
      Inflict D3 mortal wounds to the target unit before attacking.'
    ];

    let playerPriorityRound = [
      'HERO PHASE<br>\
        Gain a Command Point from your general. Use a Heroic Ability. Wizards can use magic.',
      'MOVEMENT PHASE<br>\
        Move, run or retreat units.',
      "SHOOTING PHASE<br>\
        Units shoot with missile weapons.",
      "CHARGE PHASE<br>\
        Units can attempt to charge enemy units.",
      'COMBAT PHASE (Player priority)<br>\
        Starting with the player, take turns to fight with units using melee weapons. Remove effects and\
        counters at the end of the combat phase.',
      'BATTLESHOCK PHASE<br>\
        Test the resolve of depleted units.',
      'ACTION PHASE<br>\
        All AI Heroes gain 1 react token, to a maximum of 1.\
        Take turns activating the AI units, starting with the unit with the fewest models in it.',
      'COMBAT PHASE (AI priority)<br>\
        Starting with the AI, take turns to fight with units using melee weapons. Remove effects and\
        counters at the end of the combat phase.',
      'BATTLESHOCK PHASE<br>\
        Test the resolve of depleted units.'
    ]
    let aiPriorityRound = [
      'ACTION PHASE<br>\
        Take turns activating the AI units, starting with the one with the fewest models in it.',
      'COMBAT PHASE (AI priority)<br>\
        Starting with the AI, take turns to fight with units using melee weapons. Remove effects and\
        counters at the end of the combat phase.',
      'BATTLESHOCK PHASE<br>\
        Test the resolve of depleted units.',
      'HERO PHASE<br>\
        Gain a Command Point from your general. Use a Heroic Ability. Wizards can use magic.',
      'MOVEMENT PHASE<br>\
        Move, run or retreat units.',
      "SHOOTING PHASE<br>\
        Units shoot with missile weapons.",
      "CHARGE PHASE<br>\
        Units can attempt to charge enemy units.",
      'COMBAT PHASE (Player priority)<br>\
        Starting with the player, take turns to fight with units using melee weapons. Remove effects and\
        counters at the end of the combat phase.',
      'BATTLESHOCK PHASE<br>\
        Test the resolve of depleted units.'
    ]


    let m = new Monitor(document.getElementById("monitor"));
    let actionDeck = new Deck(actionDeckData);
    let abilityDeck = new Deck(abilityDeckData);
    let totalDecks = [actionDeck,abilityDeck];
    let battleDashboard = new Dashboard(m, totalDecks);
    battleDashboard.startNewGame();

    function handleKeypress(monitor, decks){
      let x = event.keyCode;
      let newCard = {};
      //console.log("Key pressed!" + x);
      switch(x) {
        case 49: // 1
          newCard = decks[0].drawCard();
          monitor.write(newCard.text);
        break;
        case 50: // 2
          newCard = decks[1].drawCard();
          monitor.write(newCard.text);
        break;

        case 110: // n
          battleDashboard.startNewGame();
        break;

        case 46: // .
          battleDashboard.processNextPhase();
        break;

        default:
          monitor.write("Invalid key: " + x);
      }
    }

  </script>
</body>
</html>
